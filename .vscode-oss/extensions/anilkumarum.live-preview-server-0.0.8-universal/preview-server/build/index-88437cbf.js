"use strict";const t={Tab:9,LineBreak:10,FormFeed:12,CarriageReturn:13,Space:32,ExclamationMark:33,Number:35,Amp:38,SingleQuote:39,DoubleQuote:34,Dash:45,Dot:46,Dollar:36,Slash:47,Zero:48,Nine:57,SemiColon:59,Lt:60,Eq:61,Gt:62,Questionmark:63,UpperA:65,LowerA:97,UpperF:70,LowerF:102,UpperZ:90,LowerZ:122,LowerX:120,LowerS:115,LowerC:99,LowerL:108,LowerT:116,OpeningParentheses:40,ClosingParentheses:41,OpeningSquareBracket:91,openingCurlyBracket:123,closingCurlyBracket:125},e="1",s="BeforeTagName",i="InTagName",a="InSelfClosingTag",r="BeforeClosingTagName",n="InClosingTagName",h="AfterClosingTagName",o="BeforeAttributeName",l="InAttributeName",d="AfterAttributeName",u="BeforeAttributeValue",c="InAttributeValueDq",f="InAttributeValueNq",g="InAttributeValueCurly",m={NoValue:0,Unquoted:1,Double:3},N={CmtEnd:new Uint8Array([45,45,62]),Doctype:new Uint8Array([60,33,68,79,67,84,89,80,69,32,104,116,109,108,62,10,60,104,116,109,108,32,108,97,110,103,61,34,101,110,34,62]),ScriptTag:new Uint8Array([60,47,115,99,114,105,112,116,62]),StyleTag:new Uint8Array([60,47,115,116,121,108,101,62])};class x{constructor(){}on(t,e){this[t]={cb:e}}once(t,e){this[t]={cb:e,once:!0}}emit(t,...e){this[t].cb(...e),this[t].once&&delete this[t]}}function p(e){return e===t.Space||e===t.LineBreak||e===t.Tab}function T(e){return e===t.Slash||e===t.Gt||p(e)}class b extends x{state=e;sectionStart=-1;index=-1;size=0;constructor(){super()}skipTillSequence(t){const e=t.length,s=[];for(;++this.index<this.size;){const i=s.length;if(e===i)break;const a=this.buffer.charCodeAt(this.index);t[i]===a?s.push(a):s.length=0}}fastForwardTo(t){for(;this.buffer.charCodeAt(++this.index)!==t&&this.index!==this.size;);return!0}emitData(t){const e=this.buffer.slice(this.sectionStart,this.index);this.emit(t,e,this.sectionStart+this.offset,this.index+this.offset)}stateAfterClosingTagName(s){(s===t.Gt||this.fastForwardTo(t.Gt))&&(this.state=e,this.sectionStart=this.index+1)}stateInClosingTagName(e){(e===t.Gt||p(e))&&(this.emit("closeelem",this.index+this.offset),this.sectionStart=-1,this.state=h,this.stateAfterClosingTagName(e))}stateBeforeClosingTagName(s){p(s)||(s===t.Gt?this.state=e:(this.state=n,this.sectionStart=this.index))}stateInSelfClosingTag(s){s===t.Gt?(this.emit("selfcloseelem",this.index+this.offset),this.state=e,this.sectionStart=this.index+1,this.isSpecial=!1):p(s)||(this.state=o,this.stateBeforeAttributeName(s))}handleInAttributeValue(t,e){(t===e||this.fastForwardTo(e))&&(this.emitData("attrvalue"),this.sectionStart=-1,this.state=o)}stateInAttributeValueDoubleQuotes(e){this.handleInAttributeValue(e,t.DoubleQuote)}stateInAttributeValueCurlyBraces(t){this.handleInAttributeValue(t,m.curly)}stateBeforeAttributeValue(e){e===t.DoubleQuote?(this.state=c,this.sectionStart=this.index+1):p(e)||(this.sectionStart=this.index,this.state=f,this.emitData("attrvalue"))}stateAfterAttributeName(e){e===t.Eq?this.state=u:e===t.Slash||e===t.Gt?(this.state=o,this.stateBeforeAttributeName(e)):p(e)||(this.state=l,this.sectionStart=this.index)}stateInAttributeName(e){(e===t.Eq||T(e))&&(this.emitData("attrname"),this.sectionStart=-1,this.state=d,this.stateAfterAttributeName(e))}skipStyleScript(){const s=this.index-5;this.buffer.charCodeAt(s+1)===t.LowerT?(this.skipTillSequence(N.StyleTag),this.emitData("styleelem")):this.buffer.charCodeAt(s+1)===t.LowerC&&this.skipTillSequence(N.ScriptTag),this.sectionStart=-1,this.state=e}stateBeforeAttributeName(s){s===t.Gt?(this.state=e,this.sectionStart=this.index+1,this.buffer.charCodeAt(this.index-5)===t.LowerS&&this.skipStyleScript()):s===t.Slash?this.state=a:s===t.openingCurlyBracket?(this.sectionStart=this.index+1,this.fastForwardTo(t.closingCurlyBracket),this.emitData("attrname"),this.emitData("attrvalue"),this.sectionStart=-1,this.state=o):p(s)||(this.state=l,this.sectionStart=this.index)}stateInTagName(t){T(t)&&(this.emitData("openelem"),this.sectionStart=-1,this.state=o,this.stateBeforeAttributeName(t))}stateBeforeTagName(s){s===t.Slash?this.state=r:s===t.ExclamationMark?((s=this.buffer.charCodeAt(++this.index))===t.UpperD?this.fastForwardTo(t.Gt):s===t.Dash&&this.skipTillSequence(N.CommentEnd),this.sectionStart=-1,this.state=e):(this.sectionStart=this.index,this.state=i)}stateText(e){if(p(e))return++this.sectionStart;(e===t.Lt||this.fastForwardTo(t.Lt))&&(this.sectionStart>0&&this.emitData("text"),this.state=s,this.sectionStart=this.index)}allStates={[e]:this.stateText,[s]:this.stateBeforeTagName,[i]:this.stateInTagName,[o]:this.stateBeforeAttributeName,[l]:this.stateInAttributeName,[d]:this.stateAfterAttributeName,[c]:this.stateInAttributeValueDoubleQuotes,[g]:this.stateInAttributeValueCurlyBraces,[u]:this.stateBeforeAttributeValue,[a]:this.stateInSelfClosingTag,[n]:this.stateInClosingTagName,[r]:this.stateBeforeClosingTagName,[h]:this.stateAfterClosingTagName};consume(t,s=0){for(this.buffer=t,this.size=t.length,this.offset=s;++this.index<this.size;){const t=this.buffer.charCodeAt(this.index);this.allStates[this.state].call(this,t)}return this.buffer=null,this.index=-1,this.state=e,!0}}class A{static ELEMENT=1;static TEXT=3;static nodeCount=-1;constructor(t,e){this.type=t||A.TEXT,this.start=e,this.end=null,this._previous=null,this._next=null,this.id=++A.nodeCount}}class S extends A{constructor(t,e){super(A.ELEMENT,e),this.tagName=t,this.attributes=null}}class E extends A{constructor(t,e,s){super(A.TEXT,e),this.nodeValue=t,this.end=s}}class w{constructor(t,e){this.name=t,this.start=e,this.end=null,this.value=null}}class C{#t=[];constructor(t){this.htmlUpdater=t,this.tokenizer=new b,this.#e()}parse(t,e){this.isPatch=e>0;const s=this.tokenizer.consume(t,e);return this.#t.length=0,0!==this.#t.length||s}#s(t,e){const s=new S(t,e);this.htmlUpdater.add(s,this.isPatch,this.isPatch&&this.#t.at(-1)?.id),this.#t.push(s)}#i(t,e){this.attribute=new w(t,e)}#a(t,e,s){this.#t.at(-1).attributes??=[],this.attribute.end=s,this.attribute.value=t,this.#t.at(-1).attributes.push(this.attribute),this.attribute=null}#r(t,e,s){if(0===t.length)return;const i=new E(t,e,s);this.htmlUpdater.add(i,this.isPatch,this.isPatch&&this.#t.at(-1)?.id)}#n(t,e,s){t.slice(0,-7),this.#h(e)}#o(t){this.#h(t)}#h(t){this.#t.at(-1).end=t,this.#t.pop()}#e(){this.tokenizer.on("openelem",this.#s.bind(this)),this.tokenizer.on("attrname",this.#i.bind(this)),this.tokenizer.on("attrvalue",this.#a.bind(this)),this.tokenizer.on("text",this.#r.bind(this)),this.tokenizer.on("styleelem",this.#n.bind(this)),this.tokenizer.on("selfcloseelem",this.#o.bind(this)),this.tokenizer.on("closeelem",this.#h.bind(this)),this.tokenizer.on("error",(t=>console.error(t)))}}const D="InTagName",I="InAttribute",k="InElement",_="InTagEnd",L="AfterElemEnd",y="InStyle",v="InSscript";class B{constructor(){}head={_next:null};crtNode=this.head;patchNodes=[];add(t,e,s=null){e&&this.patchNodes.push(B.#l(t,s)),this.crtNode._next&&(t._next=this.crtNode._next,this.crtNode._next._previous=t),this.crtNode._next=t,t._previous=this.crtNode,this.crtNode=t}#d(t){let e=this.head;for(;e._next.start<=t&&(e=e._next,e&&e._next););return e}shiftTree(t,e,s=0){t.end+=e,t.attributes&&B.#u(t.attributes,e,s);let i=t._next;for(;i;)i.start+=e,i.attributes&&B.#u(i.attributes,e),i.end+=e,i=i._next}static#u(t,e,s=0){for(let i=s;i<t.length;i++){const s=t[i];s.start+=e,s.end+=e}}static shiftParent(t,e,s){t.type===A.ELEMENT&&t.end>e&&(t.end+=s);let i=t._previous;for(;i;)i.type===A.ELEMENT&&i.end>e&&(i.end+=s),i=i._previous}getNearestNodeAt(t){return this.#d(t)}static findRelativeNode(t,e){return t._next?{relation:"NextSibling",kinNodeId:t._next.id}:{relation:"Parent",kinNodeId:B.#c(t,e)}}static#c(t,e){for(;t.end<e;)t=t._previous;return t.id}findNodeById(t){let e=this.crtNode;for(;e=e._previous;)if(e.id===t)return e;for(e=this.head;e=e._next;)if(e.id===t)return e}static getStateInElemAt(t,e){if(!e)return null;const s=e.start+e.tagName.length+1;return e.attributes&&t<e.attributes.at(-1)?.end+1?t<s?D:I:t<s?D:t===e.end?L:t<e.end-e.tagName.length+2?"style"===e.tagName?y:"script"===e.tagName?v:k:_}static getCrtAttrIndex(t,e){for(let s=0;s<e.attributes.length;s++){const i=e.attributes[s];if(t>=i.start&&t<=i.end)return s}return-1}removeElementsInRange(t,e){let s=this.#d(t),i=[];for(;s._next.start<=e&&(s=s._next,s.start>=t&&s.end<=e&&(i.push(s.id),s._previous._next=s._next),s&&s._next););return i.length>0?i:null}static#l({_next:t,_previous:e,...s},i){return s.type===A.TEXT?{type:s.type,nodeValue:s.nodeValue,parentId:i}:s.type===A.ELEMENT?{type:s.type,attributes:s.attributes,tagName:s.tagName,parentId:i}:void 0}static prettyNode({_next:t,_previous:e,...s}){console.log(s)}}const V=new RegExp(/([^=]+)="([^"]+)/);class O extends B{#f;constructor(t){super(),this.#f=new C(this),this.isParsedSuccess=this.#f.parse(t)}reParseOnSave(){this.head={_next:null},this.crtNode=this.head,A.nodeCount=-1,this.#f.parse(this.document.getText())}insertNewElems(t,e){this.crtNode=e,this.patchNodes.length=0,this.#f.parse(t.text,t.start);const s=t.text.length;return B.shiftParent(e,t.start,t.text.length),this.crtNode._next&&(this.crtNode._next.start+=s,this.shiftTree(this.crtNode._next,s)),0===this.patchNodes.length?null:this.patchNodes}insertNewTxtNode(t,e,s){this.crtNode=t;const i=e.text.length+e.rangeOffset,a=new E(e.text,e.rangeOffset,i);this.add(a,!1);const r=e.text.length-e.rangeLength;s===k&&(t.end+=r),this.shiftTree(t._next,r),B.shiftParent(t,e.rangeOffset,r)}#g(t,e,{rangeOffset:s,rangeLength:i,text:a}){const r=s-t.start;t[e]=t[e].replaceAt(r,i,a),this.shiftTree(t,a.length-i)}updateTxtNode(t,e){return this.#g(t,"nodeValue",e),B.shiftParent(t,e.rangeOffset,e.text.length-e.rangeLength),t.nodeValue}updateElemTagName(t,e){return this.#g(t,"tagName",e),t.tagName}updateElemAttribute(t,e){const{rangeOffset:s,rangeLength:i,text:a}=e;t.attributes??=[];const r=B.getCrtAttrIndex(s,t);if(-1===r)return;const n=t.attributes[r],h=s-n.start<=n.name.length?"name":"value",o=n[h],l="name"===h?s-n.start:s-(n.start+n.name.length+2);return a?(n[h]=n[h].replaceAt(l,i,a),n.end+=a.length-i,this.shiftTree(t,a.length-i,r+1)):(n[h]=n[h].replaceAt(l,i),n.end-=i,this.shiftTree(t,-i,r+1)),{oldTxt:o,prop:h,data:n}}addNewAttribute(t,e){const[s,i,a]=t.text.match(V),r=new w(i,t.start);return r.end=t.start+t.text.length,r.value=a,{action:"addNewAttr",nodeId:e.id,attribute:r}}}String.prototype.replaceAt=function(t,e=0,s=""){return this.substring(0,t)+s+this.substring(t+e)};exports.HtmlRefresher=class extends O{constructor(t){super(t.getText()),this.document=t}getElemDataAtOffset(e){const{rangeOffset:s,text:i}=e,a=this.getNearestNodeAt(s);if(i.charCodeAt(0)===t.LineBreak||i.charCodeAt(0)===t.Tab)return this.shiftTree(a,i.length),B.shiftParent(a,e.rangeOffset,i.length),null;if(i.endsWith(">"))return this.#m(e,a);const r=a.type===A.ELEMENT,n=r?B.getStateInElemAt(s,a):null;if(n===y||n===v)return this.shiftTree(a,i.length-e.rangeLength),null;if(!i)return this.#N(e,a,n,r);if(i.endsWith('""')){const t='""'!==i?this.#x(e):{start:e.rangeOffset,text:i};return this.addNewAttribute(t,a)}return n?this.#p[n]?.(e,a,n):this.#T(e,a)}#m(t,e){const{rangeOffset:s,rangeLength:i,text:a}=t;0===i||this.updateTxtNode(e,{text:"",rangeLength:i,rangeOffset:s});const r=a.startsWith("<")?{text:a,start:s}:this.#b(t),n={action:"insertNewNodes",patchNodes:null};if(r.start>e.end&&(n.relative=B.findRelativeNode(e,r.start)),n.relative||e.type!==A.TEXT)n.patchNodes=this.insertNewElems(r,e),n.nodeId=e.id;else{if(!(""===e.nodeValue))return this.#A(t,e);e._previous._next=e._next,n.patchNodes=this.insertNewElems(r,e._previous),n.replaceTxtNodeId=e.id}return n}#A(t,e){const{rangeOffset:s,text:i}=t,a={action:"replaceSiblings",nodeId:e.id,siblingDataArr:[]},r=e.nodeValue.slice(s-e.start),n={text:"",rangeLength:r.length,rangeOffset:s},h=this.updateTxtNode(e,n);a.siblingDataArr.push({action:"updateTxtNode",txtData:h});const o={text:i,start:s},l=this.insertNewElems(o,e),d={action:"insertNewNodes",patchNodes:l};a.siblingDataArr.push(d);const u=new E(r,s+i.length);return this.crtNode.id===l[0].id||(this.crtNode=this.findNodeById(l[0])),this.add(u,!1),a.siblingDataArr.push({action:"addTxtNode",txtData:u.nodeValue}),a}#N(t,e,s,i){const a=this.removeElementsInRange(t.rangeOffset,t.rangeOffset+t.rangeLength);return a?{action:"removeNodes",nodeIds:a}:i?this.#p[s]?.(t,e,s):this.#T(t,e)}#p={[D]:this.#S.bind(this),[I]:this.#E.bind(this),[L]:this.#w.bind(this),[k]:this.#w.bind(this)};#T(t,e){if(t.rangeOffset>e.end){const s=B.findRelativeNode(e,t.rangeOffset),i=new E(t.text,t.rangeOffset,t.rangeOffset+t.text.length);return this.crtNode=e,this.add(i,!1),{action:"addTxtNode",relative:s,txtData:i.nodeValue}}const s=this.updateTxtNode(e,t);return{action:"updateTxtNode",nodeId:e.id,txtData:s}}#S(t,e){const s=this.updateElemTagName(e,t);return{action:"updateTagName",nodeId:e.id,tagName:s}}#E(t,e){const s=this.updateElemAttribute(e,t);return{action:"name"===s.prop?"updateAttrName":"updateAttrValue",nodeId:e.id,attribute:s}}#w(t,e){return this.insertNewTxtNode(e,t),{action:"addTxtNode",nodeId:e.id,txtData:t.text}}#b(e){const{lineSelTxt:s,lineStartPos:i}=this.#C(e);let a=s.length;for(;--a;)if(s.charCodeAt(a)===t.Lt&&s.charCodeAt(a+1)!==t.Slash){return{text:s.slice(a),start:this.document.offsetAt(i)+a}}}#x(e){const{lineSelTxt:s,lineStartPos:i}=this.#C(e);let a=s.length;for(;--a;)if(s.charCodeAt(a)===t.Space){return{text:s.slice(a+1),start:this.document.offsetAt(i)+a+1}}}#C(t){const{range:e,text:s}=t,i=e.start.line,a=e.start.with(i,0),r=e.start.character+s.length,n=e.start.with(i,r),h=e.with(a,n);return{lineSelTxt:this.document.getText(h),lineStartPos:a}}};
