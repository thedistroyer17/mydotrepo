"use strict";class t{constructor(t,e,s,r,i,n){this.type=t,this.selector=e,this.declarations=[],this.start=s,this.selectorEnd=r,this.end=null,this._previous=null,this._next=null,this.name=null,this.parentRule=n,this.index=i}}class e{constructor(t,e){this.property=t,this.start=e,this.value=null,this.end=null}}class s{constructor(){}head={_next:null};crtRule=this.head;patchRules=[];add(t,e){this.crtRule._next&&(t._next=this.crtRule._next,this.crtRule._next._previous=t),this.crtRule._next=t,t._previous=this.crtRule,this.crtRule=t}walkForwardUntil(t){let e=this.head;for(;e._next.start<=t&&(e=e._next,e&&e._next););return{status:t<=e.end?"current":"previous",cssRule:e}}walkBackwardUntil(t,e){let s=t;if(!s._previous)return null;for(;s._previous.end>=e&&(s=s._previous,s&&s._previous););return s.end>e?s:null}shiftLinks(t,e,r,i=0,n){"current"===r&&(t.end+=e,n&&(t.selectorEnd+=e),s.shiftDeclarationForward(t.declarations,e,i));let a=t._next;for(;a;)a.start+=e,a.selectorEnd+=e,s.shiftDeclarationForward(a.declarations,e),a.end+=e,a=a._next}static shiftDeclarationForward(t,e,s=0){if(-1!==s)for(let r=s;r<t.length;r++){const s=t[r];s.start+=e,s.end+=e}}static shiftParent(t,e,s){t.end>e&&(t.end+=s);let r=t._previous;for(;r;)r.end>e&&(r.end+=s),r=r._previous}getRuleAtPosition(t){return this.walkForwardUntil(t)}static getCrtDeclarationIndex(t,e){for(let s=0;s<e.declarations.length;s++){const r=e.declarations[s];if(t>=r.start&&t<=r.end)return s}return-1}static getNxtDeclarationIdxAfterOffset(t,e){return t.findIndex((t=>t.start>e))}findParentRule(t,e){return this.walkBackwardUntil(t,e)}static prettyRule({_next:t,_previous:e,...s}){console.log(s)}}const r=9,i=10,n=32,a=38,o=64,l=42,h=47,c=58,u=59,d=62,f=123,p=125,x=126,R="BeforeAtRuleBlock",g="BeforeSelector",m="BeforeNestedSelector",k="InSelector",S="InDeclarationBlock",D="CloseDeclarationBlock",A=new Set([46,35,c,l]),C=new Set([...A,d,x]),I=1,v=3,w=4,_=5,T=6,B=7,b=10,y=11,N=14,P=17,F=18,z=19,L=20,O=21,E=27,U={charset:E,"color-profile":O,container:L,"counter-style":y,"font-face":_,"font-feature-values":N,"font-palette-values":z,import:v,keyframes:B,layer:F,media:w,namespace:b,page:T,property:P},W={[E]:null,[O]:"name",[L]:"conditionText",[y]:"conditionText",[_]:null,[N]:"fontFamily",[z]:"fontFamily",[v]:null,[B]:"name",[F]:"name",[w]:"conditionText",[b]:"",[T]:"selectorText",[P]:"name"};class ${constructor(){}on(t,e){this[t]={cb:e}}once(t,e){this[t]={cb:e,once:!0}}emit(t,...e){this[t].cb(...e),this[t].once&&delete this[t]}}function G(t){return t===r||t===i||t===n}class j extends ${state=g;sectionStart=-1;index=-1;size=0;offset=0;constructor(){super()}parseError(t){this.status="error",console.error("expected character"+String.fromCharCode(t))}#t(t){for(;this.buffer.charCodeAt(++this.index)!==t;)if(this.index===this.size)return this.parseError(t);return!0}#e(t,e){for(;this.buffer.charCodeAt(++this.index)!==t;){if(this.index===this.size)return this.parseError(t);if(this.buffer.charCodeAt(this.index)===e)break}return!0}#s(){if(++this.index,this.#t(l),!this.#r(h))return this.#s();this.index=this.index+2}#i(t){return t===h&&this.#r(l)&&this.#s(),G(this.buffer.charCodeAt(this.index))?this.#n():this.buffer.charCodeAt(this.index)}#n(){for(;++this.index<this.size;){const t=this.buffer.charCodeAt(this.index);if(t!==i&&t!==r&&t!==n)break}return this.buffer.charCodeAt(this.index)}#a(t,...e){const s=this.buffer.slice(this.sectionStart,this.index);this.emit(t,s,this.sectionStart+this.offset,this.index+this.offset,e)}validTagName(){return this.index,!0}#r(t){return this.buffer.charCodeAt(this.index+1)===t}#o(){this.sectionStart=this.index,this.#t(n);const t=this.buffer.slice(this.sectionStart,this.index);U[t]&&(this.sectionStart=this.index+1,this.#l(t))}#l(t){"layer"!==t?this.#t(f):this.#e(f,u),this.#a("openrule",t),this.state=g}#h(t){if(G(t)&&(t=this.#n()),t===p)return this.state=g,this.#a("closerule");G(t)&&(t=this.#n()),t===a?this.state=m:(this.state=g,this.#c(this.buffer.charCodeAt(this.index)))}#u(t){return G(t)&&(t=this.#n()),(t=this.#i(t))===a?this.state=m:t===p?(this.state=D,this.#a("closerule")):(this.sectionStart=this.index,this.#t(c),this.#a("addproperty"),this.#r(n)?this.index=this.index+2:++this.index,this.sectionStart=this.index,this.#t(u),this.#a("declaration"),this.sectionStart=-1,void(this.#r(i)&&++this.index))}#d(){this.#t(f),this.#a("openrule"),this.state=S}#f(t){this.#r(n)&&(t=this.buffer.charCodeAt(this.index+1)),C.has(t)?(this.sectionStart=this.index-1,this.#t(f),this.#a("openrule"),this.state=S):this.validTagName()&&(this.state=k,this.sectionStart=this.index-1)}#c(t){if(G(t)&&(t=this.#n()),(t=this.#i(t))===a)return this.state=m;A.has(t)?(this.state=k,this.sectionStart=this.index):t===o?(this.state=R,this.sectionStart=this.index):this.validTagName()&&(this.state=k,this.sectionStart=this.index)}allStates={[g]:this.#c,[k]:this.#d,[R]:this.#o,[S]:this.#u,[D]:this.#h,[m]:this.#f};consume(t,e=0){for(this.buffer=t,this.size=t.length,this.offset=e,this.status="processing";++this.index<this.size;){const t=this.buffer.charCodeAt(this.index);this.allStates[this.state].call(this,t)}return this.buffer=null,this.index=-1,this.state=g,"error"!==this.status}}class q{#p;ruleStack=[];#x;#R={null:-1};constructor(t){this.cssUpdater=t,this.#x=new j,this.#g()}parse(t,e){this.offset=e;const s=this.#x.consume(t,e);return 0===this.ruleStack.length||s}resetIdx(){this.#R={null:-1},this.ruleStack=[]}updateChildIdx(t){const e=String(t);void 0!==this.#R[e]&&--this.#R[e]}#m(){let t=null;if(0!==this.ruleStack.length){const e=this.ruleStack.at(-1).index;t=this.ruleStack.at(-1).parentRule?[...this.ruleStack.at(-1).parentRule,e]:[e]}const e=String(t);this.#R[e]??=-1;return{ruleIndex:++this.#R[e],parentRule:t}}#k(e,s,r,i){const n=i[0]||I,{ruleIndex:a,parentRule:o}=this.#m(),l=new t(n,e.trimEnd(),s,r,a,o);this.cssUpdater.add(l,this.offset>0),this.ruleStack.push(l)}#S(t,s){this.#p=new e(t,s)}#D(t,e,s){this.#p.value=t,this.#p.end=s,this.ruleStack.at(-1).declarations.push(this.#p),this.#p=null}#A(t,e,s){this.ruleStack.at(-1).end=s,this.ruleStack.pop()}#g(){this.#x.on("openrule",this.#k.bind(this)),this.#x.on("addproperty",this.#S.bind(this)),this.#x.on("declaration",this.#D.bind(this)),this.#x.on("closerule",this.#A.bind(this))}}const H="InSelector",J="InDeclaration";class K extends s{#C;constructor(t){super(),this.#C=new q(this),this.isParsedSuccess=this.#C.parse(t)}reParseOnSave(){this.#C.resetIdx(),this.head={_next:null},this.crtRule=this.head,this.#C.parse(this.document.getText())}insertNewRule(t,e){this.crtRule=t.cssRule;const r="current"===t.status?this.crtRule:this.findParentRule(t.cssRule,e.start);r&&this.parser.ruleStack.push(r),this.parser.parse(e.ruleTxt,e.start);const i=e.ruleTxt.length;return this.shiftLinks(t.cssRule._next,i),r&&s.shiftParent(t.cssRule,e.start,i),0!==this.crtRule.declarations.length?{action:"insertRule",parentRule:this.crtRule.parentRule,index:this.crtRule.index,ruleTxt:M(this.crtRule)}:null}getStateInRuleAt(t,e){return t<=e.selectorEnd?H:t<e.end?J:null}updateRuleSelector(t,e){const{rangeOffset:r,rangeLength:i,text:n}=e,a=r-t.start;t.selector=t.selector.replaceAt(a,i,n);const o=n.length-i;return this.shiftLinks(t,o,"current",0,!0),t.parentRule&&s.shiftParent(t,r,o),t.selector}updateRuleDeclarations(t,e){const{rangeOffset:r,rangeLength:i,text:n}=e,a=s.getCrtDeclarationIndex(r,t);if(-1===a)return;const o=t.declarations[a],l="current",h=r-o.start<=o.property.length?"property":"value",c="property"===h?r-o.start:r-(o.start+o.property.length+2),u=o[h];if(n){o[h]=o[h].replaceAt(c,i,n.trim());const e=n.length-i;o.end+=n.length-i,this.shiftLinks(t,n.length-i,l,a+1),t.parentRule&&s.shiftParent(t,r,e)}else o[h]=o[h].replaceAt(c,i),o.end-=i,o[h]||t.declarations.splice(a,1),this.shiftLinks(t,i,l,a+1),t.parentRule&&s.shiftParent(t,r,-i);return{prop:h,oldTxt:u,declaration:o}}addNewDeclaration(t,{start:r,declarationTxt:i}){const[n,a]=i.split(":"),o=t,l=new e(n.trim(),r);l.end=r+i.length,l.value=a.trimStart().replace(/;$/,"");const h=s.getNxtDeclarationIdxAfterOffset(o.declarations,r);return-1===h?o.declarations.push(l):o.declarations.splice(h,0,l),this.shiftLinks(o,i.length,"current",h),o.parentRule&&s.shiftParent(o,r,i.length),l.value?1!==o.declarations.length?{action:"addDeclaration",parentRule:o.parentRule,index:o.index,declaration:l}:{action:"insertRule",parentRule:this.crtRule.parentRule,index:this.crtRule.index,ruleTxt:M(o)}:null}removeRuleInRange(t,e){let{cssRule:s}=this.walkForwardUntil(t),r=[];if(s.start>=t&&s.end<=e&&(r.push({parentRule:s.parentRule,index:s.index}),s._previous._next=s._next),!s._next){for(const t of r)this.parser.updateChildIdx(t.parentRule);return r.length>0?r:null}for(;s._next.start<=e&&(s=s._next,s.start>=t&&s.end<=e&&(r.push({parentRule:s.parentRule,index:s.index}),s._previous._next=s._next),s&&s._next););for(const t of r)this.parser.updateChildIdx(t.parentRule);return r.length>0?r:null}removeRuleDeclaration(t,e){const s=e.rangeOffset,r=e.rangeOffset+e.rangeLength,i=[];for(const e of t.declarations)e.start>=s&&e.end<=r&&i.push(e.property);return i.length>0?i:null}}function M(t){const e=[];e.push(t.selector+" {");for(const s of t.declarations)e.push(`${s.property}: ${s.value};`);return e.push("}"),e.join(" ")}String.prototype.replaceAt=function(t,e=0,s=""){return this.substring(0,t)+s+this.substring(t+e)};const Q=new RegExp(/[a-z-]+:[^;]+;/);exports.CssRefresher=class extends K{constructor(t){super(t.getText()),this.document=t}getRuleDataAtOffset(t){const{rangeOffset:e,text:n}=t,{status:a,cssRule:o}=this.getRuleAtPosition(e);if(n.charCodeAt(0)===i||n.charCodeAt(0)===r){const t=s.getNxtDeclarationIdxAfterOffset(o.declarations,e);return this.shiftLinks(o,n.length,a,t),o.parentRule&&s.shiftParent(o,e,n.length),null}if(!n)return this.#I(t,o);if(n.includes("{")){const e=this.#v(t);if(!e)return null;const s={start:e.start,ruleTxt:e.ruleTxt};return this.insertNewRule({status:a,cssRule:o},s)}if("previous"===a)return this.shiftLinks(o,n.length,a);if(n.endsWith(";")){const e=this.#w(t,Q);if(!e)return null;const s={start:e.start,declarationTxt:e.text};return this.addNewDeclaration(o,s)}return"current"===a?this.#_(t,o):void 0}#_(t,e){e??=this.getRuleAtPosition(t.rangeOffset).cssRule;const s=this.getStateInRuleAt(t.rangeOffset,e);return s===H?this.#T(t,e):s===J?this.#B(t,e):void 0}#T(t,e){const s=this.updateRuleSelector(e,t);if(s)return{action:"ruleSelector",parentRule:e.parentRule,index:e.index,selector:s,selectorType:W[e.type]}}#B(t,e){const s=this.updateRuleDeclarations(e,t);if(s)return{action:"ruleDeclarations",parentRule:e.parentRule,index:e.index,declaration:s}}#I(t,e){const{rangeOffset:s,rangeLength:r}=t;if(r>5){if(e.start>=s&&e.end<=s+r){const t=this.removeRuleInRange(s,s+r);if(t)return{action:"removeRules",rmRulesData:t}}const i=this.removeRuleDeclaration(e,t);if(i)return{action:"removeDeclarations",parentRule:e.parentRule,index:e.index,rmDeclarations:i}}return this.#_(t,e)}#v(t){const e=t.range.start.line,s=t.range.start.with(e,0),n=this.document.lineAt(e).text;let o=n.length;for(;n.charCodeAt(--o)!==f;);let l=o;for(;--o;){const t=n.charCodeAt(o);if(t===i||t===r||t===a)break}n.charCodeAt(o)!==i&&n.charCodeAt(o)!==r||++o;const h=n.slice(o,l)+t.text.slice(t.text.indexOf("{"));return h?{ruleTxt:h,start:this.document.offsetAt(s)+o}:null}#w(t,e){const s=this.document.getWordRangeAtPosition(t.range.start,e);return s?{text:this.document.getText(s),start:this.document.offsetAt(s.start)}:null}};
