"use strict";var e=require("node:http"),t=require("node:fs/promises"),i=require("node:path"),s=require("stream");const n={".ico":"image/vnd.microsoft.icon",".aac":"audio/aac",".avi":"video/x-msvideo",".bin":"application/octet-stream",".mp3":"audio/mpeg",".oga":"audio/ogg",".html":"text/html",".htm":"text/html",".shtml":"text/html",".htmlx":"text/html",".hbs":"text/html",".txt":"text/plain",".js":"text/javascript",".mjs":"text/javascript",".ts":"text/javascript",".css":"text/css",".json":"application/json",".csv":"text/csv",".md":"text/markdown",".xhtml":"application/xhtml+xml",".xml":"application/xml",".doc":"application/msword",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".epub":"application/epub+zip",".pdf":"application/pdf",".php":"application/x-httpd-php",".ppt":"application/vnd.ms-powerpoint",".sh":"application/x-sh",".xls":"application/vnd.ms-excel",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".csh":"application/x-csh",".gz":"application/gzip",".zip":"application/zip",".rar":"application/vnd.rar",".7z":"application/x-7z-compressed",".tar":"application/x-tar",".jar":"application/java-archive",".bz":"application/x-bzip",".bz2":"application/x-bzip2",".ttf":"font/ttf",".woff":"font/woff",".woff2":"font/woff2",".otf":"font/otf",".eot":"application/vnd.ms-fontobject",".bmp":"image/bmp",".png":"image/png",".jpg":"image/jpg",".jpeg":"image/jpeg",".webp":"image/webp",".avif":"image/avif",".svg":"image/svg+xml",".heic":"mage/heic",".gif":"image/gif",".mp4":"video/mp4",".mpeg":"video/mpeg",".ogv":"video/ogg",".3gp":"video/3gpp"},r=new Uint8Array([60,115,99,114,105,112,116,32,105,100,61,34,108,105,118,101,95,112,114,101,118,105,101,119,95,105,100,115,34,32,116,121,112,101,61,34,109,111,100,117,108,101,34,32,115,114,99,61,34,47,99,108,105,101,110,116,45,104,109,114,46,106,115,34,62,60,47,115,99,114,105,112,116,62]),o=new Uint8Array([60,115,99,114,105,112,116,32,105,100,61,34,108,105,118,101,95,112,114,101,118,105,101,119,95,105,100,115,34,62,10,103,108,111,98,97,108,84,104,105,115,46,108,105,118,101,80,114,101,118,105,101,119,73,100,115,32,61,32,110,101,119,32,77,97,112,40,41,59,10,118,97,114,32,108,112,115,78,111,100,101,73,100,32,61,32,45,49,59,10,10,103,108,111,98,97,108,84,104,105,115,46,115,101,116,76,112,115,78,111,100,101,73,100,32,61,32,102,117,110,99,116,105,111,110,32,40,110,111,100,101,41,32,123,10,9,99,111,110,115,116,32,110,111,116,101,73,100,32,61,32,43,43,108,112,115,78,111,100,101,73,100,59,10,9,110,111,100,101,46,108,105,118,101,80,114,101,118,105,101,119,73,100,32,61,32,110,111,116,101,73,100,59,10,9,108,105,118,101,80,114,101,118,105,101,119,73,100,115,46,115,101,116,40,110,111,116,101,73,100,44,32,110,101,119,32,87,101,97,107,82,101,102,40,110,111,100,101,41,41,59,10,125,59,10,10,97,100,100,69,118,101,110,116,76,105,115,116,101,110,101,114,40,34,68,79,77,67,111,110,116,101,110,116,76,111,97,100,101,100,34,44,32,40,101,118,101,110,116,41,32,61,62,32,123,10,9,99,111,110,115,116,32,110,111,100,101,73,116,101,114,97,116,111,114,32,61,32,100,111,99,117,109,101,110,116,46,99,114,101,97,116,101,84,114,101,101,87,97,108,107,101,114,40,100,111,99,117,109,101,110,116,41,59,10,10,9,108,101,116,32,110,111,100,101,59,10,9,119,104,105,108,101,32,40,40,110,111,100,101,32,61,32,110,111,100,101,73,116,101,114,97,116,111,114,46,110,101,120,116,78,111,100,101,40,41,41,41,32,123,10,9,9,105,102,32,40,110,111,100,101,46,110,111,100,101,84,121,112,101,32,61,61,61,32,78,111,100,101,46,69,76,69,77,69,78,84,95,78,79,68,69,41,32,123,10,9,9,9,110,111,100,101,46,105,100,32,33,61,61,32,34,108,105,118,101,95,112,114,101,118,105,101,119,95,105,100,115,34,32,38,38,32,115,101,116,76,112,115,78,111,100,101,73,100,40,110,111,100,101,41,59,10,9,9,125,32,101,108,115,101,32,105,102,32,40,110,111,100,101,46,110,111,100,101,84,121,112,101,32,61,61,61,32,78,111,100,101,46,84,69,88,84,95,78,79,68,69,32,38,38,32,33,110,111,100,101,46,110,111,100,101,86,97,108,117,101,46,115,116,97,114,116,115,87,105,116,104,40,34,92,110,34,41,41,32,115,101,116,76,112,115,78,111,100,101,73,100,40,110,111,100,101,41,59,10,9,125,10,125,41,59,10,60,47,115,99,114,105,112,116,62]),a={Dot:46,Slash:47};function c(e){let t=e.length;for(;t--;)if(e.charCodeAt(t)===a.Dot)return[e.slice(0,t),e.slice(t)]}const l=new Set([".html",".stml",".htm",".htmlx"]),h=new Set(["html","stml","htm","htmlx"]);function p(e,t){t.writeHead(404),t.end(e+" file not found")}const d=new Uint8Array([60,33,68,79,67,84,89,80,69,32,104,116,109,108,62,10,60,104,116,109,108,32,108,97,110,103,61,34,101,110,34,62]);async function f(e,i,c){try{const c=await t.open(e);if(c){const t=function(e){let t=e.length;for(;t--;)if(e.charCodeAt(t)===a.Dot)return e.slice(t)}(e);i.writeHead(200,{"Content-Type":n[t]});const h=c.createReadStream();l.has(t)&&(h.push(d),h.push(r),h.push(o)),s.pipeline(h,i,(e=>e&&console.log(e)))}}catch(e){i.writeHead(404),i.end("file not found")}}class u{constructor(e,t,i){this.id=e,this.name=e,this.isDirectory=i,this.path=t,i&&(this.files=[])}}const m={compilerOptions:{module:99,jsx:0,target:99}};let g="/usr/local/lib/node_modules/typescript";"win32"===process.platform&&(g=`C:\\Users\\${process.env.USERNAME}\\AppData\\Roaming\\npm\\node_modules`);const v=new Set(["/client-hmr.js","/live-refresh.js"]),w="/dir-panel/index.hbs";class x{extensionPath;userCustom;userConfig;liveRefresher;logger;crtPageUrl;constructor(e){this.cwd=e,this.docFileExtMap=new Map,async function(e,i){let s=[];s.push(async function n(r){const o=await t.readdir(e+r,{withFileTypes:!0});for(const e of o){const t=`${r}/${e.name}`;if(e.isDirectory())s.push(n(t));else{const e=c(t);e&&l.has(e[1])&&i.set(e[0],e[1])}}}("")),await Promise.all(s).catch((e=>console.error(e)))}(e,this.docFileExtMap)}handleGetRequest(e,t,s){if(v.has(s)){f(i.join(this.extensionPath,"scripts",s),t)}else{const i="navigate"===e.headers["sec-fetch-mode"],n="iframe"===e.headers["sec-fetch-dest"];this.serveFileOnRoute(s,i,n,t)}}async serveFileOnRoute(e,s,n,r){let o="";if(s){if(function(e){let t=e.length;for(;t--;){const i=e.charCodeAt(t);if(i===a.Dot)return!0;if(i===a.Slash)return!1}}(e)||(o=this.docFileExtMap.get(e)||""),"/paths"===e)return f(i.join(this.extensionPath,w),r);const s=await t.stat(this.cwd+e+o).catch((t=>{((e,t)=>{t.writeHead(404),t.end(`<!DOCTYPE html>\n    <html lang="en">\n    \n    <head>\n        <meta charset="UTF-8">\n        <meta name="viewport" content="width=device-width, initial-scale=1.0">\n        <title>404 error, page not found</title>\n    </head>\n    \n    <body>\n        <h1>404 error, Page not found</h1>\n        <p>${e} file doesn't exist</p>\n        <a href="/dir-panel/index.hbs">Open Directory Panel</a>\n    </body>\n    \n    </html>`)})(e,r),this.logger.log(`[${(new Date).toLocaleTimeString()}] ${e} 404 error`)}));if(!s)return;if(r.setHeader("X-Powered-By","Live Preview Server"),s.isDirectory()||"/paths"===e){return f(i.join(this.extensionPath,w),r)}this.userCustom.httpHeaders&&this.#e(r),e!==this.crtPageUrl&&this.logger.log(`[${(new Date).toLocaleTimeString()}] ${e}`),this.crtPageUrl=e}else{if(e.startsWith("/dir-panel")){return f(this.extensionPath+e,r)}if(e.startsWith("/dir-data-request"))return await this.#t(e,r);if(this.userConfig.compileTs&&e.endsWith(".ts"))try{const i=await async function(e){try{const{transpileModule:i}=require(g),s=i(await t.readFile(e,{encoding:"utf8"}),m);return s.outputText?s.outputText:"cannot compile"}catch(e){return e.message}}(this.cwd+e);return r.writeHead(200,{"Content-Type":"text/javascript"}),r.end(i)}catch(t){return p(e,r)}}f(this.cwd+e+o,r)}#e(e){const t=this.userCustom.httpHeaders;if(t)for(const i in t)t[i]&&e.setHeader(i,t[i])}async#t(e,i){let s;switch(e){case"/dir-data-request/dirs-tree":s=await async function(e){const i={root:[]};let s=[];return s.push(async function i(n,r){const o=await t.readdir(e+n,{withFileTypes:!0});for(const e of o){const t=`${n}/${e.name}`;if(e.isDirectory()){const n=new u(e.name,t,!0);r.push(n),s.push(i(t,n.files))}else r.push(new u(e.name,t,!1))}}("",i.root)),await Promise.all(s).catch((e=>console.error(e))),await new Promise((e=>setTimeout(e,100))),i}(this.cwd);break;case"/dir-data-request/redirect-routes":s=await async function(e,t,i){const s=e+"/.vscode/redirects.json",n=await import(s).catch((e=>{console.error("no file")}));let r=n?n.default:{},o=[];return t.forEach(((e,t)=>{const i=t+e,s={filePath:i,redirects:r[i]||[]};o.push(s)})),o}(this.cwd,this.docFileExtMap)}i.writeHead(200,{"Content-Type":"json"}),i.write(JSON.stringify(s)),i.end()}handleOtherReqest(e,i,s){let n="";if(e.on("data",(e=>n+=e)),e.on("end",(async()=>{"/dir-data-request/add-redirect-route"===s?(await async function(e,i){const s=JSON.parse(i),n=e+"/.vscode/redirects.json",r=await import(n).catch((e=>{console.error("redirects.json not find")})),o=r?r.default:{};o[s.filePath]??=[],o[s.filePath].push(s.redirectPath),await t.writeFile(n,JSON.stringify(o))}(this.cwd,n),i.writeHead(200,{"Content-Type":"application/json"}),i.end('{"status":"saved success"}')):p(s,i)})),"PATCH"===e.method&&e.url.startsWith("/view/highlight-node-vscode")){const t=new URLSearchParams(e.url).get("node"),i=this.liveRefresher.get(this.cwd+e.headers.referer);i&&i.findNodeById(t)}}}const P=(e,t)=>e.log(`ðŸ”´ Preview server running at ${t} port`);let R,y;exports.PreviewServer=class extends x{#i;#s;port;isRunning=!1;clientConnect;constructor(e,t,s,n,r){super(e),this.extensionPath=i.join(t,"preview-server"),s.liveRefresh&&async function(){R=(await Promise.resolve().then((function(){return require("./index-88437cbf.js")}))).HtmlRefresher,y=(await Promise.resolve().then((function(){return require("./index-e07de3d8.js")}))).CssRefresher}(),this.liveRefresher=new Map,this.userCustom=r,this.userConfig=s,this.logger=n,this.isLiveFresh=s.liveRefresh}async startServer(t){return new Promise(((i,s)=>{if(this.isRunning)return i(t);this.port=t,this.#i=e.createServer().listen(t,P.bind(null,this.logger,t)),this.#i.on("request",this.#n),this.#i.once("error",(()=>s("cannot start server at port "+t))),this.#i.once("listening",(()=>{this.isRunning=!0,this.logger.log(`Local: http://localhost:${t}/paths`),i(t)})),this.#i.once("close",(()=>{this.isRunning=!1,this.#s.end(),this.logger.log("Live Server Stopped"),this.logger.dispose()}))}))}#r(e){this.clientConnect||(this.logger.log("âœ… 'Client connected'"),this.logger.log("âŒ› Waiting for file change..."),this.clientConnect=!0),e.writeHead(200,{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET,OPTIONS","Access-Control-Allow-Private-Network":"true","Access-Control-Allow-Headers":"Cache-Control","Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}),e.write("event:notice\ndata:LPS Hmr connected\n\n")}#n=(e,t)=>{const[i,s]=e.url.split("?",2);if("/ws"===i)return this.#s=t,this.#r(t);"GET"===e.method?this.handleGetRequest(e,t,i):this.handleOtherReqest(e,t,i)};closeServer(){this.logger.log("Live Server Stopping..."),this.#i.close()}changePageUrl(e){if(!h.has(e.languageId))return;const t=this.#o(e.fileName);t!==this.crtPageUrl&&this.#s?.write(`event:pagenav\ndata:${t}\n\n`)}reloadOnSave=e=>{this.liveRefresher&&this.liveRefresher.has(e.fileName)&&this.liveRefresher.get(e.fileName).reParseOnSave();const t=this.#o(e.fileName);this.#s?.write(`data:${t}\n\n`)};#a(e){this.#s?.write(`data:${JSON.stringify(e)}\n\n`)}updateElementAtPosition=(e,t)=>{if(!this.liveRefresher)return console.error("live refresh not enabled");const i=this.liveRefresher.get(t.fileName).getElemDataAtOffset(e);i&&this.#a(i)};updateRuleAtPosition=(e,t)=>{if(!this.liveRefresher)return console.error("live refresh not enabled");const i=this.liveRefresher.get(t.fileName).getRuleDataAtOffset(e);i&&(i.sheetUrl=this.#o(t.fileName),this.#a(i))};async parseLiveRefresher(e){this.isLiveFresh&&(R||await new Promise((e=>setTimeout(e,100))),this.liveRefresher.has(e.fileName)||(h.has(e.languageId)?this.liveRefresher.set(e.fileName,new R(e)):"css"===e.languageId&&this.liveRefresher.set(e.fileName,new y(e))))}#o(e){return e.slice(this.cwd.length)}};
